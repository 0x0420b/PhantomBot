(function(){var e={pollId:0,options:[],votes:[],voters:[],callback:function(){},pollRunning:false,pollMaster:"",time:0,question:"",minVotes:0,result:"",pollTimerId:-1};function o(o,t,i,l,r,a,p){if(e.pollRunning){return false}e.pollRunning=true;e.pollMaster=l;e.time=isNaN(i)||i==0?false:i*1e3;e.callback=r;e.question=o;e.options=t;e.minVotes=a?a:0;if(p){s(l,p)}$.say($.resolveRank(l)+'started a poll "'+e.question+'"! Use "!vote [option]" to vote. Options: "'+e.options.join('", "')+'".');if(e.time){e.pollTimerId=setTimeout(function(){n();clearTimeout(e.pollTimerId)},e.time)}return true}function s(o,s){var n;if(!e.pollRunning){$.say($.whisperPrefix(o)+"There's currently no poll running.")}if($.list.contains(e.voters,o.toLowerCase())){$.say($.whisperPrefix(o)+$.resolveRank(o)+", you have already voted!");return}else{e.voters.push(o)}if(!$.list.contains(e.options,s)){$.say($.whisperPrefix(o)+'"'+s+'" is not a valid option!');return}if(n=e.options.indexOf(s)>-1){e.votes.push(e.options[n]);$.say($.whisperPrefix(o)+'You have voted "'+e.options[n]+'" on "'+e.question+'".')}else{$.say($.whisperPrefix(o)+"That option does not exist.")}}function n(){var o={},s;if(!e.pollRunning){return}if(e.pollTimerId>-1){clearTimeout(e.pollTimerId);e.pollTimerId=-1}if(e.minVotes>0&&e.votes.length<e.minVotes){e.callback(false);return}for(s in e.votes){o[s]=(o[s]||0)+1}e.result=Object.keys(o).reduce(function(e,s){return e===undefined||o[s]>o[e]?+s:e});e.callback(e.result);e.pollRunning=false}$.bind("command",function(t){var i=t.getSender().toLowerCase(),l=t.getCommand(),r=t.getArguments().trim(),a=t.getArgs(),p=a[0];if(l.equalsIgnoreCase("vote")&&p){if(!pollRunning){$.say($.whisperPrefix(i)+"There is no poll running!");return}s(i,p)}if(l.equalsIgnoreCase("poll")){if(!p){if(pollRunning){$.say($.whisperPrefix(i)+'There is a poll running for "'+e.question+'". Use "!vote [option]" to vote. The options are "'+e.options.join('", "')+'".')}return}if(!$.isMod(i)){$.say($.whisperPrefix(i)+$.modMsg);return}if(p.equalsIgnoreCase("results")){if(pollMaster!=""){$.say('[Last Poll] - [Question: "'+e.question+'"] - [Total votes: '+e.votes.length+'] - [Result: "'+result+'"] - [Options: "'+e.options.join('", "')+'"]')}else{$.say($.whisperPrefix(i)+"There is no latest poll to retrieve results from!")}}if(p.equalsIgnoreCase("open")){var u=parseInt(r.replace(/-t\s([0-9]+)/,"$1")),f=r.replace(/-q\s".+"/,"$1"),m=r.replace(/-o\s".+"/,"$1").split(", ");if(isNaN(u)||!f||!m||m.length==0){$.say($.whisperPrefix(i)+'Usage: !poll open [-t [time]] -q "[question]" -o "[option1], [option2], ..."');return}o(f,m,u,i,function(e){if(e===false){$.say('The poll on "'+f+'" has ended! No votes were cast.');return}$.say('The poll on "'+f+'" has ended! The winner is "'+e+'"!')});$.say($.whisperPrefix(i)+'Poll started! use "!poll close" to end the poll manually or use "!poll result" to get the latest results')}if(p.equalsIgnoreCase("close")){if(!pollRunning){$.say($.whisperPrefix(i)+"There is no poll running.");return}n()}}});$.bind("initReady",function(){if($.bot.isModuleEnabled("./systems/pollSystem.js")){$.registerChatCommand("./systems/pollSystem.js","poll",7);$.registerChatCommand("./systems/pollSystem.js","vote",7)}});$.poll={runPoll:o,endPoll:n}})();