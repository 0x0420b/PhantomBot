(function(){var e=($.inidb.exists("tgBattleSettings","waitTime")?parseInt($.inidb.get("tgBattleSettings","waitTime")):60)*1e3,t=$.inidb.exists("tgBattleSettings","foodCost")?parseInt($.inidb.get("tgBattleSettings","foodCost")):2,a=$.inidb.exists("tgBattleSettings","lostFunDecr")?parseInt($.inidb.get("tgBattleSettings","lostFunDecr")):2,n=$.inidb.exists("tgBattleSettings","winFunIncr")?parseInt($.inidb.get("tgBattleSettings","winFunIncr")):4,i=.75,g=1,l={active:false,senderTG:null,targetTG:null,waitTimerId:-1};function r(a,n){var i=$.tamagotchi.getByOwner(a),r=$.tamagotchi.getByOwner(n);if(!i||!r||a.equalsIgnoreCase(n)){$.say($.lang.get("tgbattle.notready.missingtg"));return false}if(!i.isHappy()){$.say($.lang.get("tgbattle.notready.lowfun",i.name));return false}if(!r.isHappy()){$.say($.lang.get("tgbattle.notready.lowfun",r.name));return false}if(Math.floor(i.foodLevel)<=t+1){$.say($.lang.get("tgbattle.notready.lowfood",i.name));return false}if(Math.floor(r.foodLevel)<=t+1){$.say($.lang.get("tgbattle.notready.lowfood",r.name));return false}l.waitTimerId=setTimeout(function(){$.say($.lang.get("tgbattle.wait.timedout",$.username.resolve(r.owner)));i.decrFunLevel(g).save();l={active:false,senderTG:null,targetTG:null,waitTimerId:-1};clearTimeout(l.waitTimerId)},e);l.active=true;l.senderTG=i;l.targetTG=r;$.say($.lang.get("tgbattle.wait.foraccept",i.name,r.name,$.username.resolve(r.owner)))}function s(){var e=l.senderTG,g=l.targetTG,r=Math.max(Math.min(e.expLevel-g.expLevel,10),-10),s=$.randRange(0,24)<=10+r,o;clearTimeout(l.waitTimerId);$.say($.lang.get("tgbattle.battle.starting",l.senderTG.name,l.targetTG.name));o=setTimeout(function(){l.senderTG.incrExpLevel(s?i*2:i).decrFoodLevel(t).incrFunLevel(s?n:-a).save();l.targetTG.incrExpLevel(!s?i*2:i).decrFoodLevel(t).incrFunLevel(!s?n:-a).save();if(s){$.say($.lang.get("tgbattle.battle.done",l.senderTG.name,l.targetTG.name))}else{$.say($.lang.get("tgbattle.battle.done",l.targetTG.name,l.senderTG.name))}l.active=false;clearTimeout(o)},5e3)}$.bind("command",function(e){var t=e.getCommand(),a=e.getSender(),n=e.getArgs();if(t.equalsIgnoreCase("tgbattle")){if(n.length!=1){$.say($.whisperPrefix(a)+$.lang.get("tgbattle.usage"));return}r(a,n[0])}if(t.equalsIgnoreCase("tgbaccept")&&l.active&&l.targetTG.owner.equalsIgnoreCase(a)){$.consoleLn(a+" accepted the battle");s()}});$.bind("initReady",function(){if($.bot.isModuleEnabled("./games/tamagotchi/tg-battle.js")){$.registerChatCommand("./games/tamagotchi/tg-battle.js","tgbattle",6);$.registerChatCommand("./games/tamagotchi/tg-battle.js","tgbaccept",6)}})})();